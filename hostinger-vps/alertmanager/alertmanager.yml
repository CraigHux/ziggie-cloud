# =============================================================================
# ALERTMANAGER CONFIGURATION - ZIGGIE COMMAND CENTER
# =============================================================================
# Production-ready alert routing with multi-channel notifications
# =============================================================================

global:
  # Default resolve timeout
  resolve_timeout: 5m

  # SMTP Configuration (for email alerts)
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'ziggie-alerts@ziggie.cloud'
  smtp_auth_username: '${SMTP_USERNAME}'
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_require_tls: true

  # Slack Configuration
  slack_api_url: '${SLACK_WEBHOOK_URL}'

# Alert templates
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Routing tree
route:
  # Default receiver
  receiver: 'default-receiver'

  # Group by alertname to reduce noise
  group_by: ['alertname', 'severity', 'service']

  # Wait before sending first notification for a new group
  group_wait: 30s

  # Wait before sending notification about new alerts in a group
  group_interval: 5m

  # Wait before re-sending a notification
  repeat_interval: 4h

  # Child routes for specific handling
  routes:
    # Critical alerts - immediate notification
    - match:
        severity: critical
      receiver: 'critical-receiver'
      group_wait: 10s
      repeat_interval: 1h
      continue: true

    # AWS-specific alerts
    - match:
        tier: cloud
      receiver: 'aws-receiver'
      group_by: ['alertname', 'service']
      continue: true

    # Database alerts
    - match:
        tier: database
      receiver: 'database-receiver'
      group_by: ['alertname', 'service']

    # Infrastructure alerts
    - match:
        tier: infrastructure
      receiver: 'infrastructure-receiver'
      group_by: ['alertname', 'instance']

    # Application alerts
    - match:
        tier: application
      receiver: 'application-receiver'
      group_by: ['alertname', 'service']

    # Warning-level alerts (lower urgency)
    - match:
        severity: warning
      receiver: 'warning-receiver'
      group_wait: 2m
      repeat_interval: 6h

# Inhibition rules to suppress less severe alerts
inhibit_rules:
  # If a critical alert is firing, suppress warnings for the same service
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'service']

  # If host is down, suppress container alerts for that host
  - source_match:
      alertname: 'HostDown'
    target_match_re:
      alertname: 'Container.*'
    equal: ['instance']

  # If database is down, suppress dependent application alerts
  - source_match:
      alertname: 'PostgresDown'
    target_match_re:
      alertname: '(ZiggieApiDown|SimStudioDown|N8nDown)'

# Receiver configurations
receivers:
  # Default receiver - Slack only
  - name: 'default-receiver'
    slack_configs:
      - channel: '#ziggie-alerts'
        send_resolved: true
        title: '{{ template "slack.default.title" . }}'
        text: '{{ template "slack.default.text" . }}'
        color: '{{ if eq .Status "firing" }}{{ if eq .CommonLabels.severity "critical" }}danger{{ else }}warning{{ end }}{{ else }}good{{ end }}'

  # Critical alerts - Slack + Email + PagerDuty (if configured)
  - name: 'critical-receiver'
    slack_configs:
      - channel: '#ziggie-critical'
        send_resolved: true
        title: ':fire: CRITICAL: {{ .CommonLabels.alertname }}'
        text: |
          *Service:* {{ .CommonLabels.service }}
          *Severity:* {{ .CommonLabels.severity }}
          *Summary:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          *Description:* {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
        color: 'danger'
    email_configs:
      - to: 'team@ziggie.cloud'
        send_resolved: true
        headers:
          Subject: '[CRITICAL] Ziggie Alert: {{ .CommonLabels.alertname }}'
    # Optional: PagerDuty integration
    # pagerduty_configs:
    #   - service_key: '${PAGERDUTY_SERVICE_KEY}'
    #     severity: 'critical'

  # AWS-specific alerts
  - name: 'aws-receiver'
    slack_configs:
      - channel: '#ziggie-aws'
        send_resolved: true
        title: ':cloud: AWS Alert: {{ .CommonLabels.alertname }}'
        text: |
          *Service:* {{ .CommonLabels.service }}
          *Summary:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
        color: '{{ if eq .Status "firing" }}{{ if eq .CommonLabels.severity "critical" }}danger{{ else }}warning{{ end }}{{ else }}good{{ end }}'

  # Database alerts
  - name: 'database-receiver'
    slack_configs:
      - channel: '#ziggie-database'
        send_resolved: true
        title: ':floppy_disk: Database Alert: {{ .CommonLabels.alertname }}'
        text: |
          *Database:* {{ .CommonLabels.service }}
          *Summary:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
        color: '{{ if eq .Status "firing" }}{{ if eq .CommonLabels.severity "critical" }}danger{{ else }}warning{{ end }}{{ else }}good{{ end }}'

  # Infrastructure alerts
  - name: 'infrastructure-receiver'
    slack_configs:
      - channel: '#ziggie-infra'
        send_resolved: true
        title: ':gear: Infrastructure Alert: {{ .CommonLabels.alertname }}'
        text: |
          *Instance:* {{ .CommonLabels.instance }}
          *Summary:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
        color: '{{ if eq .Status "firing" }}{{ if eq .CommonLabels.severity "critical" }}danger{{ else }}warning{{ end }}{{ else }}good{{ end }}'

  # Application alerts
  - name: 'application-receiver'
    slack_configs:
      - channel: '#ziggie-app'
        send_resolved: true
        title: ':package: Application Alert: {{ .CommonLabels.alertname }}'
        text: |
          *Service:* {{ .CommonLabels.service }}
          *Summary:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
        color: '{{ if eq .Status "firing" }}{{ if eq .CommonLabels.severity "critical" }}danger{{ else }}warning{{ end }}{{ else }}good{{ end }}'

  # Warning-level alerts
  - name: 'warning-receiver'
    slack_configs:
      - channel: '#ziggie-warnings'
        send_resolved: true
        title: ':warning: Warning: {{ .CommonLabels.alertname }}'
        text: |
          *Service:* {{ .CommonLabels.service }}
          *Summary:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
        color: 'warning'
