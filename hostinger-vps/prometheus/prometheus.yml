# =============================================================================
# PROMETHEUS CONFIGURATION - ZIGGIE COMMAND CENTER
# =============================================================================
# Full observability for 18-service Docker stack + AWS resources
# Target: Production-grade monitoring with actionable alerts
# =============================================================================

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    monitor: 'ziggie-production'
    environment: 'production'

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093

# Rule files
rule_files:
  - /etc/prometheus/alerts/*.yml

# Scrape configurations
scrape_configs:
  # ===========================================================================
  # PROMETHEUS SELF-MONITORING
  # ===========================================================================
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
        labels:
          service: 'prometheus'
          tier: 'monitoring'

  # ===========================================================================
  # CONTAINER METRICS (cAdvisor)
  # ===========================================================================
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']
        labels:
          tier: 'infrastructure'
    metric_relabel_configs:
      # Drop high-cardinality container labels to reduce storage
      - regex: 'container_label_.*'
        action: labeldrop

  # ===========================================================================
  # HOST METRICS (Node Exporter)
  # ===========================================================================
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']
        labels:
          tier: 'infrastructure'
          host: 'ziggie-vps'

  # ===========================================================================
  # DATABASE MONITORING
  # ===========================================================================

  # PostgreSQL
  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres-exporter:9187']
        labels:
          service: 'postgres'
          tier: 'database'
          database: 'ziggie'

  # MongoDB
  - job_name: 'mongodb'
    static_configs:
      - targets: ['mongodb-exporter:9216']
        labels:
          service: 'mongodb'
          tier: 'database'

  # Redis
  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']
        labels:
          service: 'redis'
          tier: 'database'

  # ===========================================================================
  # WORKFLOW ORCHESTRATION
  # ===========================================================================

  # n8n (via custom metrics endpoint)
  - job_name: 'n8n'
    static_configs:
      - targets: ['n8n:5678']
        labels:
          service: 'n8n'
          tier: 'workflow'
    metrics_path: /metrics
    scheme: http

  # ===========================================================================
  # AI/LLM SERVICES
  # ===========================================================================

  # Ollama
  - job_name: 'ollama'
    static_configs:
      - targets: ['ollama:11434']
        labels:
          service: 'ollama'
          tier: 'ai'
    metrics_path: /api/metrics
    scheme: http

  # Flowise
  - job_name: 'flowise'
    static_configs:
      - targets: ['flowise:3000']
        labels:
          service: 'flowise'
          tier: 'ai'

  # Open WebUI
  - job_name: 'open-webui'
    static_configs:
      - targets: ['open-webui:8080']
        labels:
          service: 'open-webui'
          tier: 'ai'

  # ===========================================================================
  # ZIGGIE CORE SERVICES
  # ===========================================================================

  # Ziggie API (FastAPI with prometheus_client)
  - job_name: 'ziggie-api'
    static_configs:
      - targets: ['ziggie-api:8000']
        labels:
          service: 'ziggie-api'
          tier: 'application'
    metrics_path: /metrics
    scheme: http

  # MCP Gateway
  - job_name: 'mcp-gateway'
    static_configs:
      - targets: ['mcp-gateway:8080']
        labels:
          service: 'mcp-gateway'
          tier: 'application'
    metrics_path: /metrics
    scheme: http

  # Sim Studio
  - job_name: 'sim-studio'
    static_configs:
      - targets: ['sim-studio:8001']
        labels:
          service: 'sim-studio'
          tier: 'application'
    metrics_path: /metrics
    scheme: http

  # ===========================================================================
  # REVERSE PROXY & SSL
  # ===========================================================================

  # Nginx
  - job_name: 'nginx'
    static_configs:
      - targets: ['nginx-exporter:9113']
        labels:
          service: 'nginx'
          tier: 'infrastructure'

  # ===========================================================================
  # MONITORING STACK
  # ===========================================================================

  # Grafana
  - job_name: 'grafana'
    static_configs:
      - targets: ['grafana:3000']
        labels:
          service: 'grafana'
          tier: 'monitoring'
    metrics_path: /metrics
    scheme: http

  # Loki
  - job_name: 'loki'
    static_configs:
      - targets: ['loki:3100']
        labels:
          service: 'loki'
          tier: 'monitoring'
    metrics_path: /metrics
    scheme: http

  # ===========================================================================
  # CI/CD & MANAGEMENT
  # ===========================================================================

  # Portainer (agent metrics)
  - job_name: 'portainer'
    static_configs:
      - targets: ['portainer:9000']
        labels:
          service: 'portainer'
          tier: 'management'

  # ===========================================================================
  # AWS CLOUDWATCH (via YACE Exporter)
  # ===========================================================================
  - job_name: 'aws-cloudwatch'
    static_configs:
      - targets: ['yace-exporter:5000']
        labels:
          tier: 'cloud'
          provider: 'aws'
    scrape_interval: 60s  # CloudWatch has 1-minute resolution minimum
    scrape_timeout: 30s

  # ===========================================================================
  # BLACKBOX EXPORTER (Endpoint Probes)
  # ===========================================================================
  - job_name: 'blackbox-http'
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets:
          - https://ziggie.cloud/health
          - https://ziggie.cloud/api/health
          - https://ziggie.cloud/n8n/health
        labels:
          tier: 'probes'
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115

  # TCP probes for databases
  - job_name: 'blackbox-tcp'
    metrics_path: /probe
    params:
      module: [tcp_connect]
    static_configs:
      - targets:
          - postgres:5432
          - mongodb:27017
          - redis:6379
        labels:
          tier: 'probes'
          probe_type: 'tcp'
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115
