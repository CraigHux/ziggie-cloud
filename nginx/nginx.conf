events {
    worker_connections 1024;
}

http {
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Upstream services
    upstream n8n { server ziggie-n8n:5678; }
    upstream grafana { server ziggie-grafana:3000; }
    upstream prometheus { server ziggie-prometheus:9090; }
    upstream flowise { server ziggie-flowise:3000; }
    upstream openwebui { server ziggie-open-webui:8080; }
    upstream ollama { server ziggie-ollama:11434; }
    upstream ziggie_api { server ziggie-api:8000; }
    upstream mcp_gateway { server ziggie-mcp-gateway:8080; }
    upstream sim_studio { server ziggie-sim-studio:8001; }
    upstream portainer { server ziggie-portainer:9000; }

    # HTTP - redirect to HTTPS
    server {
        listen 80;
        server_name ziggie.cloud;

        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        location / {
            return 301 https://$host$request_uri;
        }
    }

    # HTTPS
    server {
        listen 443 ssl;
        server_name ziggie.cloud;

        ssl_certificate /etc/letsencrypt/live/ziggie.cloud/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/ziggie.cloud/privkey.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;

        # n8n - Workflow automation (preserve /n8n/ prefix for subpath support)
        location /n8n/ {
            proxy_pass http://n8n;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 180s;
            proxy_connect_timeout 60s;
            proxy_send_timeout 180s;
        }

        # Grafana - Monitoring
        location /grafana/ {
            proxy_pass http://grafana/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Flowise - LLM workflows (extended timeout for AI inference)
        location /flowise/ {
            proxy_pass http://flowise/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_read_timeout 180s;
            proxy_connect_timeout 60s;
            proxy_send_timeout 180s;
        }

        # Open WebUI - Chat interface (extended timeout for AI inference)
        location /chat/ {
            proxy_pass http://openwebui/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_read_timeout 180s;
            proxy_connect_timeout 60s;
            proxy_send_timeout 180s;
        }

        # Ziggie API (extended timeout for AI inference)
        location /api/ {
            proxy_pass http://ziggie_api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 180s;
            proxy_connect_timeout 60s;
            proxy_send_timeout 180s;
        }

        # MCP Gateway (extended timeout for AI inference)
        location /mcp/ {
            proxy_pass http://mcp_gateway/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_read_timeout 180s;
            proxy_connect_timeout 60s;
            proxy_send_timeout 180s;
        }

        # Sim Studio (extended timeout for AI inference)
        location /sim/ {
            proxy_pass http://sim_studio/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 180s;
            proxy_connect_timeout 60s;
            proxy_send_timeout 180s;
        }

        # Ollama API (extended timeout for AI inference)
        location /ollama/ {
            proxy_pass http://ollama/;
            proxy_set_header Host $host;
            proxy_read_timeout 180s;
            proxy_connect_timeout 60s;
            proxy_send_timeout 180s;
        }

        # Prometheus metrics
        location /prometheus/ {
            proxy_pass http://prometheus/;
            proxy_set_header Host $host;
        }

        # Portainer
        location /portainer/ {
            proxy_pass http://portainer/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
        }

        # Default landing
        location / {
            default_type text/html;
            return 200 '<html><body style="font-family:sans-serif;padding:40px;"><h1>Ziggie Cloud</h1><ul><li><a href="/n8n/">n8n - Workflows</a></li><li><a href="/grafana/">Grafana - Monitoring</a></li><li><a href="/flowise/">Flowise - LLM Builder</a></li><li><a href="/chat/">Open WebUI - Chat</a></li><li><a href="/api/">Ziggie API</a></li><li><a href="/mcp/">MCP Gateway</a></li><li><a href="/sim/">Sim Studio</a></li></ul></body></html>';
        }
    }
}
