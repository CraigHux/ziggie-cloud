name: Deploy to Ziggie Cloud

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Sync to deployment directory
        run: |
          echo "Syncing to /opt/ziggie..."
          # Preserve .env file (contains secrets not in repo)
          rsync -av --exclude='.git' --exclude='.github' --exclude='.env' ./ /opt/ziggie/

      - name: Rebuild and restart services
        run: |
          cd /opt/ziggie

          # Rebuild custom services
          echo "Rebuilding Ziggie API..."
          docker compose build ziggie-api

          echo "Rebuilding MCP Gateway..."
          docker compose build mcp-gateway

          echo "Rebuilding Sim Studio..."
          docker compose build sim-studio

          # Restart rebuilt services
          echo "Restarting services..."
          docker compose up -d ziggie-api mcp-gateway sim-studio

          # Wait for services to be healthy
          sleep 15

      - name: Health check
        run: |
          echo "Running health checks via Docker network..."

          # Get container IPs on ziggie network
          API_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' ziggie-api)
          MCP_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' ziggie-mcp-gateway)
          SIM_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' ziggie-sim-studio)

          echo "API: $API_IP, MCP: $MCP_IP, SIM: $SIM_IP"

          # Health checks using container IPs
          curl -f http://$API_IP:8000/health || exit 1
          echo "Ziggie API: OK"

          curl -f http://$MCP_IP:8080/health || exit 1
          echo "MCP Gateway: OK"

          curl -f http://$SIM_IP:8001/health || exit 1
          echo "Sim Studio: OK"

          echo "All services healthy!"

      - name: Cleanup
        if: always()
        run: |
          docker system prune -f --volumes=false
