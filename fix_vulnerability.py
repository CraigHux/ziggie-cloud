#!/usr/bin/env python3
"""
Script to fix the path traversal vulnerability in knowledge.py
"""

import sys
from pathlib import Path

# Read the file
knowledge_file = Path("C:/Ziggie/control-center/backend/api/knowledge.py")
content = knowledge_file.read_text(encoding='utf-8')

# Define the vulnerable code to replace
old_code = '''    try:
        # Decode file_id (base64 encoded path)
        import base64
        file_path = base64.b64decode(file_id).decode('utf-8')

        if not os.path.exists(file_path):
            raise HTTPException(status_code=404, detail="File not found")

        # Get file stats
        stat = os.stat(file_path)

        # Parse insights
        insights = parse_markdown_insights(file_path)

        return {
            "path": file_path,
            "name": os.path.basename(file_path),
            "size": stat.st_size,
            "created": datetime.fromtimestamp(stat.st_ctime).isoformat(),
            "modified": datetime.fromtimestamp(stat.st_mtime).isoformat(),
            "insights": insights
        }'''

# Define the secure replacement code
new_code = '''    try:
        # Decode file_id (base64 encoded path)
        import base64
        decoded_path = base64.b64decode(file_id).decode('utf-8')

        # Resolve the path to prevent path traversal attacks
        file_path = Path(decoded_path).resolve()

        # Define allowed directories
        allowed_dirs = [
            AI_AGENTS_ROOT.resolve(),
            KB_ROOT.resolve()
        ]

        # Verify file is within allowed directories
        is_allowed = False
        for allowed_dir in allowed_dirs:
            try:
                # Check if file_path is relative to allowed_dir
                file_path.relative_to(allowed_dir)
                is_allowed = True
                break
            except ValueError:
                # file_path is not relative to this allowed_dir
                continue

        if not is_allowed:
            raise HTTPException(
                status_code=403,
                detail="Access denied: File path is outside allowed directories"
            )

        if not file_path.exists():
            raise HTTPException(status_code=404, detail="File not found")

        # Get file stats
        stat = os.stat(file_path)

        # Parse insights
        insights = parse_markdown_insights(str(file_path))

        return {
            "path": str(file_path),
            "name": file_path.name,
            "size": stat.st_size,
            "created": datetime.fromtimestamp(stat.st_ctime).isoformat(),
            "modified": datetime.fromtimestamp(stat.st_mtime).isoformat(),
            "insights": insights
        }'''

# Apply the fix
if old_code in content:
    content = content.replace(old_code, new_code)
    knowledge_file.write_text(content, encoding='utf-8')
    print("Vulnerability fixed successfully!")
    print("Applied path validation to /files/{file_id} endpoint")
    sys.exit(0)
else:
    print("ERROR: Could not find the vulnerable code pattern")
    print("The file may have already been patched or modified")
    sys.exit(1)
